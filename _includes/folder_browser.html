{% comment %}
This include generates folder structure from all static files under images/.
The folder structure is built entirely in JavaScript for better compatibility.
{% endcomment %}

<script id="allImageFiles" type="application/json">
[
  {% assign image_extensions = 'jpg,jpeg,png,gif,webp,JPG,JPEG,PNG,GIF,WEBP' | split: ',' %}
  {% assign image_files = site.static_files | where_exp: "file", "file.path contains 'images/'" %}
  {% for file in image_files %}
    {% if image_extensions contains file.extname %}
  {
    "path": "{{ file.path | relative_url }}",
    "name": "{{ file.path | split: '/' | last }}",
    "fullPath": "{{ file.path }}"
  }{% unless forloop.last %},{% endunless %}
    {% endif %}
  {% endfor %}
]
</script>

<div class="folder-browser">
  <div class="breadcrumb" id="breadcrumb">
    <a href="#" class="breadcrumb-item" data-path="">Home</a>
  </div>

  <div class="folder-view">
    <div class="folder-grid" id="folderGrid">
      <!-- Dynamically populated by JavaScript -->
    </div>
  </div>
</div>

<script>
  const allFilesEl = document.getElementById('allImageFiles');
  const allFiles = JSON.parse(allFilesEl.textContent);
  const folderGrid = document.getElementById('folderGrid');
  const breadcrumb = document.getElementById('breadcrumb');

  let currentPath = '';

  // Build folder structure from flat file list
  function buildFolderStructure() {
    const folders = {};
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];

    allFiles.forEach(file => {
      const pathParts = file.fullPath.split('/').filter(p => p);
      if (pathParts.length > 1) {
        const folderPath = pathParts.slice(0, -1).join('/');
        if (!folders[folderPath]) {
          folders[folderPath] = [];
        }
        folders[folderPath].push(file);
      }
    });

    return folders;
  }

  const folderStructure = buildFolderStructure();

  function getTopLevelFolders() {
    const topFolders = {};
    Object.keys(folderStructure).forEach(path => {
      const pathParts = path.split('/').filter(p => p);
      if (pathParts.length >= 2) {
        const topFolder = pathParts[1]; // First folder under 'images'
        if (!topFolders[topFolder]) {
          topFolders[topFolder] = [];
        }
        topFolders[topFolder] = topFolders[topFolder].concat(folderStructure[path]);
      }
    });
    return topFolders;
  }

  function getRandomThumbnail(files) {
    if (files.length === 0) return null;
    const randomIndex = Math.floor(Math.random() * files.length);
    return files[randomIndex];
  }

  function showFolders(parentPath = '') {
    folderGrid.innerHTML = '';

    if (parentPath === '') {
      // Show top-level folders
      const topFolders = getTopLevelFolders();
      Object.keys(topFolders).sort().forEach(folderName => {
        const files = topFolders[folderName];
        const thumbnail = getRandomThumbnail(files);
        if (thumbnail) {
          const card = createFolderCard(folderName, 'images/' + folderName, files.length, thumbnail.path);
          folderGrid.appendChild(card);
        }
      });
    } else {
      // Show subfolders and images at this path
      const subItems = getSubItems(parentPath);
      
      // Show subfolders
      subItems.folders.forEach(folder => {
        const card = createFolderCard(folder.name, folder.path, folder.imageCount, folder.thumbnail);
        folderGrid.appendChild(card);
      });

      // Show images
      if (subItems.images.length > 0) {
        const imagesSection = document.createElement('div');
        imagesSection.className = 'images-section';
        imagesSection.style.gridColumn = '1 / -1';
        
        const title = document.createElement('h3');
        title.textContent = 'Images in this folder';
        imagesSection.appendChild(title);

        const gallery = document.createElement('div');
        gallery.className = 'gallery';
        subItems.images.forEach(img => {
          const link = document.createElement('a');
          link.className = 'gallery-item';
          link.href = img.path;
          link.target = '_blank';
          link.rel = 'noopener';
          link.innerHTML = `
            <img src="${img.path}" alt="${img.name}" loading="lazy" />
            <div class="caption">${img.name}</div>
          `;
          gallery.appendChild(link);
        });
        imagesSection.appendChild(gallery);
        folderGrid.appendChild(imagesSection);
      }
    }
  }

  function getSubItems(parentPath) {
    const result = { folders: {}, images: [] };
    const parentSegments = parentPath.split('/').filter(p => p);

    Object.keys(folderStructure).forEach(folderPath => {
      const pathSegments = folderPath.split('/').filter(p => p);
      
      // Check if this folder is a direct child or descendant
      if (pathSegments.length > parentSegments.length) {
        let isChild = true;
        for (let i = 0; i < parentSegments.length; i++) {
          if (pathSegments[i] !== parentSegments[i]) {
            isChild = false;
            break;
          }
        }

        if (isChild) {
          if (pathSegments.length === parentSegments.length + 1) {
            // Direct child - it's an image directory
            folderStructure[folderPath].forEach(img => {
              result.images.push(img);
            });
          } else {
            // Subdirectory - treat as folder
            const nextLevelName = pathSegments[parentSegments.length];
            const nextLevelPath = pathSegments.slice(0, parentSegments.length + 1).join('/');
            
            if (!result.folders[nextLevelPath]) {
              const subFiles = [];
              Object.keys(folderStructure).forEach(subPath => {
                const subSegments = subPath.split('/').filter(p => p);
                if (subSegments.length > parentSegments.length) {
                  let match = true;
                  for (let i = 0; i < parentSegments.length + 1; i++) {
                    if (subSegments[i] !== pathSegments[i]) {
                      match = false;
                      break;
                    }
                  }
                  if (match) {
                    subFiles.push(...folderStructure[subPath]);
                  }
                }
              });

              if (subFiles.length > 0) {
                result.folders[nextLevelPath] = {
                  name: nextLevelName,
                  path: nextLevelPath,
                  imageCount: subFiles.length,
                  thumbnail: getRandomThumbnail(subFiles).path
                };
              }
            }
          }
        }
      }
    });

    return {
      folders: Object.values(result.folders),
      images: result.images
    };
  }

  function createFolderCard(folderName, folderPath, imageCount, thumbnail) {
    const card = document.createElement('div');
    card.className = 'folder-card';
    card.innerHTML = `
      <div class="folder-thumbnail" style="background-image: url('${thumbnail}');">
        <div class="folder-overlay">
          <span class="folder-icon">üìÅ</span>
        </div>
      </div>
      <div class="folder-info">
        <h3>${folderName}</h3>
        <p>${imageCount} image(s)</p>
      </div>
    `;
    card.addEventListener('click', () => {
      currentPath = folderPath;
      updateBreadcrumb(folderPath);
      showFolders(folderPath);
    });
    return card;
  }

  function updateBreadcrumb(path) {
    const pathSegments = path.split('/').filter(p => p && p !== 'images');
    let builtPath = '';

    breadcrumb.innerHTML = '<a href="#" class="breadcrumb-item" data-path="">Home</a>';

    pathSegments.forEach(segment => {
      builtPath += (builtPath ? '/' : '') + segment;
      const crumb = document.createElement('a');
      crumb.className = 'breadcrumb-item';
      crumb.href = '#';
      crumb.textContent = segment;
      crumb.setAttribute('data-path', builtPath);
      breadcrumb.appendChild(crumb);

      crumb.addEventListener('click', (e) => {
        e.preventDefault();
        const newPath = builtPath === segment ? 'images/' + crumb.getAttribute('data-path') : crumb.getAttribute('data-path');
        currentPath = newPath;
        showFolders(newPath);
        updateBreadcrumb(newPath);
      });
    });

    breadcrumb.querySelector('.breadcrumb-item[data-path=""]').addEventListener('click', (e) => {
      e.preventDefault();
      currentPath = '';
      showFolders();
      updateBreadcrumb('');
    });
  }

  // Initialize
  showFolders();
</script>
