{% comment %}
This include generates folder structure from all static files under images/.
The folder structure is built entirely in JavaScript for better compatibility.
{% endcomment %}

<script id="allImageFiles" type="application/json">
[
  {% assign image_extensions = 'jpg,jpeg,png,gif,webp,JPG,JPEG,PNG,GIF,WEBP' | split: ',' %}
  {% assign image_files = site.static_files | where_exp: "file", "file.path contains 'images/'" %}
  {% for file in image_files %}
    {% if image_extensions contains file.extname %}
  {
    "path": "{{ file.path | relative_url }}",
    "name": "{{ file.path | split: '/' | last }}",
    "fullPath": "{{ file.path }}"
  }{% unless forloop.last %},{% endunless %}
    {% endif %}
  {% endfor %}
]
</script>

<div class="folder-browser">
  <div class="breadcrumb" id="breadcrumb">
    <a href="#" class="breadcrumb-item" data-path="">Home</a>
  </div>

  <div class="folder-view">
    <div class="folder-grid" id="folderGrid">
      <!-- Dynamically populated by JavaScript -->
    </div>
  </div>
</div>

<script>
  const allFilesEl = document.getElementById('allImageFiles');
  const allFiles = JSON.parse(allFilesEl.textContent);
  const folderGrid = document.getElementById('folderGrid');
  const breadcrumb = document.getElementById('breadcrumb');

  let currentPath = '';

  // Build a tree structure from flat file list
  function buildFolderTree() {
    const tree = {};

    allFiles.forEach(file => {
      const pathParts = file.fullPath.split('/').filter(p => p);
      if (pathParts.length < 2) return; // Skip files not in images/

      let current = tree;
      for (let i = 1; i < pathParts.length - 1; i++) {
        const part = pathParts[i];
        if (!current[part]) {
          current[part] = { _folders: {}, _files: [] };
        }
        current = current[part]._folders;
      }

      // Add file to current folder
      if (!current['_files']) {
        current['_files'] = [];
      }
      current['_files'].push(file);
    });

    return tree;
  }

  const folderTree = buildFolderTree();

  function getTopLevelFolders() {
    const topFolders = [];
    if (folderTree.images && folderTree.images._folders) {
      Object.keys(folderTree.images._folders).forEach(folderName => {
        const folderData = folderTree.images._folders[folderName];
        const imageCount = countAllImages(folderData);
        if (imageCount > 0) {
          const thumbnail = getRandomThumbnail(folderData);
          topFolders.push({
            name: folderName,
            path: 'images/' + folderName,
            imageCount: imageCount,
            thumbnail: thumbnail ? thumbnail.path : null
          });
        }
      });
    }
    return topFolders;
  }

  function countAllImages(folderData) {
    let count = 0;
    if (folderData._files) {
      count += folderData._files.length;
    }
    if (folderData._folders) {
      Object.values(folderData._folders).forEach(subFolder => {
        count += countAllImages(subFolder);
      });
    }
    return count;
  }

  function getRandomThumbnail(folderData) {
    const allImages = getAllImages(folderData);
    if (allImages.length === 0) return null;
    const randomIndex = Math.floor(Math.random() * allImages.length);
    return allImages[randomIndex];
  }

  function getAllImages(folderData) {
    let images = [];
    if (folderData._files) {
      images = images.concat(folderData._files);
    }
    if (folderData._folders) {
      Object.values(folderData._folders).forEach(subFolder => {
        images = images.concat(getAllImages(subFolder));
      });
    }
    return images;
  }

  function getItemsAtPath(pathStr) {
    const pathParts = pathStr.split('/').filter(p => p && p !== 'images');
    let current = folderTree.images ? folderTree.images._folders : folderTree;

    for (let part of pathParts) {
      if (!current[part]) return { folders: [], images: [] };
      current = current[part]._folders;
    }

    const result = { folders: [], images: [] };

    // Get immediate subfolders
    if (current) {
      Object.keys(current).forEach(folderName => {
        const folderData = current[folderName];
        const imageCount = countAllImages(folderData);
        if (imageCount > 0) {
          const thumbnail = getRandomThumbnail(folderData);
          result.folders.push({
            name: folderName,
            path: pathStr + '/' + folderName,
            imageCount: imageCount,
            thumbnail: thumbnail ? thumbnail.path : null
          });
        }
      });
    }

    // Get immediate images in this level
    const pathParts2 = pathStr.split('/').filter(p => p && p !== 'images');
    let current2 = folderTree.images ? folderTree.images._folders : folderTree;

    for (let part of pathParts2) {
      if (!current2[part]) break;
      current2 = current2[part]._folders;
    }

    // Get the _files at this level
    const pathParts3 = pathStr.split('/').filter(p => p && p !== 'images');
    let current3 = folderTree.images ? folderTree.images : { _folders: folderTree };

    for (let i = 0; i < pathParts3.length; i++) {
      if (current3._folders && current3._folders[pathParts3[i]]) {
        current3 = current3._folders[pathParts3[i]];
      }
    }

    if (current3._files) {
      result.images = current3._files;
    }

    return result;
  }

  function showFolders(parentPath = '') {
    folderGrid.innerHTML = '';

    let folders = [];
    if (parentPath === '') {
      folders = getTopLevelFolders();
    } else {
      const items = getItemsAtPath(parentPath);
      folders = items.folders;
    }

    if (folders.length === 0 && parentPath !== '') {
      const items = getItemsAtPath(parentPath);
      if (items.images && items.images.length > 0) {
        showImages(items.images);
      } else {
        folderGrid.innerHTML = '<p class="empty">No folders or images found.</p>';
      }
      return;
    }

    folders.forEach(folder => {
      if (folder.thumbnail) {
        const card = createFolderCard(folder);
        folderGrid.appendChild(card);
      }
    });

    // Also show images at this level if any
    if (parentPath !== '') {
      const items = getItemsAtPath(parentPath);
      if (items.images && items.images.length > 0) {
        showImages(items.images);
      }
    }
  }

  function showImages(images) {
    const imagesSection = document.createElement('div');
    imagesSection.className = 'images-section';
    imagesSection.style.gridColumn = '1 / -1';

    const title = document.createElement('h3');
    title.textContent = 'Images in this folder';
    imagesSection.appendChild(title);

    const gallery = document.createElement('div');
    gallery.className = 'gallery';

    images.forEach(img => {
      const link = document.createElement('a');
      link.className = 'gallery-item';
      link.href = img.path;
      link.target = '_blank';
      link.rel = 'noopener';

      const imgName = img.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');

      link.innerHTML = `
        <img src="${img.path}" alt="${imgName}" loading="lazy" />
        <div class="caption">${imgName}</div>
      `;
      gallery.appendChild(link);
    });

    imagesSection.appendChild(gallery);
    folderGrid.appendChild(imagesSection);
  }

  function createFolderCard(folder) {
    const card = document.createElement('div');
    card.className = 'folder-card';
    card.innerHTML = `
      <div class="folder-thumbnail" style="background-image: url('${folder.thumbnail}');">
        <div class="folder-overlay">
          <span class="folder-icon">üìÅ</span>
        </div>
      </div>
      <div class="folder-info">
        <h3>${folder.name}</h3>
        <p>${folder.imageCount} image(s)</p>
      </div>
    `;
    card.addEventListener('click', () => {
      currentPath = folder.path;
      updateBreadcrumb(folder.path);
      showFolders(folder.path);
    });
    return card;
  }

  function updateBreadcrumb(path) {
    const pathSegments = path.split('/').filter(p => p && p !== 'images');

    breadcrumb.innerHTML = '<a href="#" class="breadcrumb-item" data-path="">Home</a>';

    let builtPath = '';
    pathSegments.forEach(segment => {
      builtPath += (builtPath ? '/' : 'images/') + segment;
      const crumb = document.createElement('a');
      crumb.className = 'breadcrumb-item';
      crumb.href = '#';
      crumb.textContent = segment;
      const finalPath = builtPath;
      crumb.addEventListener('click', (e) => {
        e.preventDefault();
        currentPath = finalPath;
        showFolders(finalPath);
        updateBreadcrumb(finalPath);
      });
      breadcrumb.appendChild(crumb);
    });

    breadcrumb.querySelector('.breadcrumb-item[data-path=""]').addEventListener('click', (e) => {
      e.preventDefault();
      currentPath = '';
      showFolders();
      updateBreadcrumb('');
    });
  }

  // Debug: log files found
  console.log('Total image files found:', allFiles.length);
  console.log('First few files:', allFiles.slice(0, 3));

  // Initialize
  showFolders();
</script>
